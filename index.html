<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Avee-like Media Player (PHP/XAMPP)</title>
  <link rel="stylesheet" href="assets/style.css?v=20251020-19">
  
  <script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>
</head>
<body>
  <header class="md-appbar" role="banner">
    <div class="appbar-row">
      <button id="top-menu" class="icon-btn" aria-label="Menu" title="Menu">☰</button>
      <div class="appbar-title">Avee-like Media Player</div>
      <div class="appbar-actions"></div>
    </div>
  </header>
  <div id="top-menu-panel" class="md-menu" aria-label="Menu">
    <div class="menu-section">
      <strong>Playlists</strong>
      <ul id="menu-playlists" class="list"></ul>
    </div>
  </div>
  <main>
    <div id="app" class="md-container md-grid app-grid">
      <!-- Library Sidebar -->
      <aside class="sidebar library">
        <div class="toolbar">
          <input type="text" id="search" placeholder="Search library..." />
          <button id="rescan" title="Rescan music folder">Rescan</button>
          <label class="upload-btn" title="Upload audio files">
            Upload
            <input type="file" id="upload-input" accept="audio/*" multiple />
          </label>
        </div>
        <details class="lib-collapsible">
          <summary>Import from URL</summary>
          <div class="toolbar">
            <input type="url" id="import-url" placeholder="Import audio URL (e.g., Dropbox direct link)" />
            <button id="import-url-btn" title="Download from URL">Import</button>
          </div>
        </details>

        <details class="lib-collapsible">
          <summary>Cloud Connections</summary>
          <div class="toolbar">
            <button id="connect-dropbox" class="btn">Connect Dropbox</button>
            <button id="connect-google" class="btn">Connect Google Drive</button>
          </div>
        </details>

        <ul id="library-list" class="list"></ul>

        <details class="lib-collapsible">
          <summary>Cloud Files</summary>
          <ul id="cloud-list" class="list"></ul>
        </details>
      </aside>

      <!-- Player Core -->
      <section class="player-core">
        <div class="art-and-info">
          <div id="art" class="art"></div>
          <div class="track-info">
            <div id="track-title" class="track-title">—</div>
            <div id="track-time" class="track-time">0:00 / 0:00</div>
          </div>
        </div>

        <!-- Visualizer layout wraps canvas + controls + tuning + EQ + logger -->
        <div class="viz-layout">

          <h2 class="viz-title">My Web Visualizer</h2>

          <canvas id="viz" width="960" height="300"></canvas>

          <div class="controls">
            <button id="prev" class="btn secondary">Prev</button>
            <button id="play" class="btn success">Play</button>
            <button id="next" class="btn secondary">Next</button>
            <button id="shuffle" class="btn secondary" title="Shuffle">Shuffle</button>
            <button id="repeat" class="btn secondary" title="Repeat">Repeat</button>

            <div class="slider-group">
              <label>Volume</label>
              <input type="range" id="volume" min="0" max="1" step="0.01" value="0.9"/>
            </div>

            <div class="slider-group">
              <label>Speed</label>
              <input type="range" id="rate" min="0.5" max="2" step="0.01" value="1"/>
            </div>

            <button id="pitch-lock" class="btn success" title="Preserve pitch when changing speed">Pitch Lock</button>

            <button id="delete-track" class="btn danger" title="Delete current track">Delete Track</button>
            
          </div>

          <!-- Floating Customize button + drawer -->
          <button id="fab-customize" class="md-fab" aria-label="Customize visualizer" title="Customize">✎</button>
          <button id="fab-layers" class="md-fab" aria-label="Layers" title="Layers">☷</button>
          <div id="viz-drawer" class="md-drawer" role="dialog" aria-modal="true" aria-labelledby="viz-drawer-title">
            <div class="drawer-head">
              <h3 id="viz-drawer-title">Customize Visualizer</h3>
              <button id="viz-drawer-close" class="icon-btn" aria-label="Close">✕</button>
            </div>
            <div class="drawer-content">
              <div class="customize">
                <div class="viz-style">
                  <label>Visualizer</label>
                  <select id="viz-style">
                    <option value="bars">Bars</option>
                    <option value="wave">Wave</option>
                    <option value="mirror">Mirror Bars</option>
                    <option value="ring">Ring Wave</option>
                    <option value="radial">Radial Bars</option>
                    <option value="particles">Particles</option>
                    <option value="circle">Circle</option>
                  </select>
                </div>
                <div class="viz-template">
                  <label>Style Template</label>
                  <select id="style-template"></select>
                </div>
                <div class="viz-colors">
                  <label>Colors</label>
                  <input type="color" id="viz-color-1" value="#19d3ae"/>
                  <input type="color" id="viz-color-2" value="#1e90ff"/>
                </div>
                <div class="viz-options">
                  <label><input type="checkbox" id="viz-glow" checked/> Glow</label>
                  <label><input type="checkbox" id="viz-trail" checked/> Trail</label>
                  <label><input type="checkbox" id="viz-art" checked/> Center Art</label>
                  <label><input type="checkbox" id="viz-style-presets" /> Style Presets</label>
                  <label><input type="checkbox" id="viz-bpm" /> Show BPM</label>
                  <label><input type="checkbox" id="viz-perf" /> Performance Mode</label>
                </div>

                <div class="viz-mode">
                  <div class="orient">
                    <label>Orientation</label>
                    <select id="viz-orient">
                      <option value="auto" selected>Auto</option>
                      <option value="portrait">Portrait</option>
                      <option value="landscape">Landscape</option>
                    </select>
                  </div>
                  <div class="theme">
                    <label>Theme</label>
                    <select id="theme-select">
                      <option value="dark" selected>Dark</option>
                      <option value="light">Light</option>
                    </select>
                  </div>
                </div>

                <div class="viz-tuning">
                  <label>Rotation <input type="range" id="viz-rot" min="0" max="3" step="0.01" value="0.6"></label>
                  <label>Decay <input type="range" id="viz-decay" min="0.7" max="0.99" step="0.001" value="0.92"></label>
                  <label>Thickness <input type="range" id="viz-thickness" min="0.5" max="3" step="0.01" value="1"></label>
                  <label>Ring Fill <input type="range" id="viz-ring-floor" min="0" max="0.3" step="0.01" value="0.16"></label>
                  <label>Radial Floor <input type="range" id="viz-radial-floor" min="0" max="0.3" step="0.01" value="0.16"></label>
                  <label>Glow Strength <input type="range" id="viz-glow-strength" min="0" max="24" step="1" value="12"></label>
                  <label>Trail Alpha <input type="range" id="viz-trail-alpha" min="0" max="0.3" step="0.01" value="0.08"></label>
                  <label>Spike Scale <input type="range" id="viz-spike-scale" min="0.5" max="2" step="0.01" value="1"></label>
                  <label>Wave Scale <input type="range" id="viz-wave-scale" min="0.5" max="2" step="0.01" value="1"></label>
                  <label>Segments <input type="range" id="viz-segments" min="1" max="8" step="1" value="4"></label>
                  <label>Beat Sensitivity <input type="range" id="viz-beat-sense" min="0.2" max="2" step="0.05" value="1"></label>
                  <label>Beat Boost <input type="range" id="viz-beat-boost" min="0" max="2" step="0.05" value="1"></label>
                  <label>Beat Threshold <input type="range" id="viz-beat-thresh" min="0" max="0.6" step="0.01" value="0.08"></label>
                  <label>Beat Decay <input type="range" id="viz-beat-decay" min="0.7" max="0.99" step="0.001" value="0.90"></label>
                  <label>Beat Source
                    <select id="viz-beat-src">
                      <option value="avg" selected>Average</option>
                      <option value="low">Low</option>
                      <option value="mid">Mid</option>
                      <option value="high">High</option>
                    </select>
                  </label>
                  <label>Beat Hold (ms) <input type="range" id="viz-beat-hold" min="0" max="500" step="10" value="120"></label>
                  <label>Pulse Width <input type="range" id="viz-pulse-w" min="0" max="2" step="0.05" value="1"></label>
                  <label>Emphasis Mode
                    <select id="viz-emphasis-mode">
                      <option value="flat" selected>Flat</option>
                      <option value="weighted">Weighted</option>
                    </select>
                  </label>
                  <label>Low Emphasis <input type="range" id="viz-low-gain" min="0" max="2" step="0.05" value="1"></label>
                  <label>Mid Emphasis <input type="range" id="viz-mid-gain" min="0" max="2" step="0.05" value="1"></label>
                  <label>High Emphasis <input type="range" id="viz-high-gain" min="0" max="2" step="0.05" value="1"></label>
                  <label>Smoothing <input type="range" id="viz-smooth" min="0.5" max="0.95" step="0.01" value="0.75"></label>
                </div>
                <div class="presets">
                  <input type="text" id="preset-name" placeholder="Preset name"/>
                  <button id="save-viz-preset" class="btn">Save Viz Preset</button>
                  <button id="save-eq-preset" class="btn">Save EQ Preset</button>
                  <select id="preset-list"></select>
                  <button id="apply-preset" class="btn">Apply Preset</button>
                  <button id="delete-preset" class="btn">Delete Preset</button>
                </div>
              </div>
            </div>
          </div>
          <div id="viz-scrim" class="md-scrim" aria-hidden="true"></div>

          <!-- Floating Layers Drawer -->
          <div id="layers-drawer" class="md-drawer" role="dialog" aria-modal="true" aria-labelledby="layers-drawer-title">
            <div class="drawer-head">
              <h3 id="layers-drawer-title">Layers</h3>
              <button id="layers-drawer-close" class="icon-btn" aria-label="Close">✕</button>
            </div>
            <div class="drawer-content">
              <div class="customize">
                <div class="viz-style">
                  <label>Layer Style</label>
                  <select id="layer-style">
                    <option value="bars">Bars</option>
                    <option value="wave">Wave</option>
                    <option value="mirror">Mirror Bars</option>
                    <option value="ring">Ring Wave</option>
                    <option value="radial">Radial Bars</option>
                    <option value="particles">Particles</option>
                    <option value="circle">Circle</option>
                  </select>
                </div>
                <div class="viz-colors">
                  <label>Colors</label>
                  <input type="color" id="layer-color-1" value="#19d3ae"/>
                  <input type="color" id="layer-color-2" value="#1e90ff"/>
                </div>
                <div class="viz-tuning">
                  <label>Segments <input type="range" id="layer-segments" min="1" max="8" step="1" value="2"></label>
                  <label>Blend Mode
                    <select id="layer-blend">
                      <option value="lighter" selected>Lighter</option>
                      <option value="normal">Normal</option>
                      <option value="screen">Screen</option>
                      <option value="multiply">Multiply</option>
                    </select>
                  </label>
                  <label>Opacity <input type="range" id="layer-alpha" min="0" max="1" step="0.05" value="1"></label>
                </div>
                <div class="presets">
                  <button id="layer-add2" class="btn primary">Add Layer</button>
                </div>
              </div>
            </div>
          </div>
          <div id="layers-scrim" class="md-scrim" aria-hidden="true"></div>

          <!-- Smart Playlist Drawer -->
          <div id="smart-drawer" class="md-drawer" role="dialog" aria-modal="true" aria-labelledby="smart-drawer-title">
            <div class="drawer-head">
              <h3 id="smart-drawer-title">Create Smart Playlist</h3>
              <button id="smart-drawer-close" class="icon-btn" aria-label="Close">✕</button>
            </div>
            <div class="drawer-content">
              <div class="customize">
                <div class="viz-style">
                  <label>Name</label>
                  <input type="text" id="smart-name2" placeholder="Smart playlist name"/>
                </div>
                <div class="viz-style">
                  <label>Name contains</label>
                  <input type="text" id="smart-contains2" placeholder="Substring"/>
                </div>
                <div class="viz-style">
                  <label>Extensions</label>
                  <input type="text" id="smart-exts2" placeholder="e.g. mp3,ogg"/>
                </div>
                <div class="viz-style">
                  <label>Folder prefix</label>
                  <input type="text" id="smart-folder2" placeholder="assets/music/subfolder"/>
                </div>
                <div class="viz-style">
                  <label>Min MB</label>
                  <input type="number" id="smart-minmb2" min="0" placeholder="0"/>
                </div>
                <div class="viz-style">
                  <label>Max MB</label>
                  <input type="number" id="smart-maxmb2" min="0" placeholder="0"/>
                </div>
                <div class="presets">
                  <button id="smart-create-btn" class="btn primary">Create Smart</button>
                </div>
              </div>
            </div>
          </div>
          <div id="smart-scrim" class="md-scrim" aria-hidden="true"></div>

          <div class="eq-header">
            <span>Equalizer</span>
            <select id="eq-preset">
              <option value="flat">Flat</option>
              <option value="pop">Pop</option>
              <option value="rock">Rock</option>
              <option value="jazz">Jazz</option>
              <option value="bass">Bass Boost</option>
              <option value="treble">Treble Boost</option>
            </select>
            <button id="eq-toggle" class="btn">Show/Hide</button>
          </div>

          <div id="eq-panel" class="eq-panel">
            <div class="bands">
              <div class="band"><label>31</label><input type="range" data-band="0" min="-12" max="12" step="0.5" value="0"/></div>
              <div class="band"><label>62</label><input type="range" data-band="1" min="-12" max="12" step="0.5" value="0"/></div>
              <div class="band"><label>125</label><input type="range" data-band="2" min="-12" max="12" step="0.5" value="0"/></div>
              <div class="band"><label>250</label><input type="range" data-band="3" min="-12" max="12" step="0.5" value="0"/></div>
              <div class="band"><label>500</label><input type="range" data-band="4" min="-12" max="12" step="0.5" value="0"/></div>
              <div class="band"><label>1k</label><input type="range" data-band="5" min="-12" max="12" step="0.5" value="0"/></div>
              <div class="band"><label>2k</label><input type="range" data-band="6" min="-12" max="12" step="0.5" value="0"/></div>
              <div class="band"><label>4k</label><input type="range" data-band="7" min="-12" max="12" step="0.5" value="0"/></div>
              <div class="band"><label>8k</label><input type="range" data-band="8" min="-12" max="12" step="0.5" value="0"/></div>
              <div class="band"><label>16k</label><input type="range" data-band="9" min="-12" max="12" step="0.5" value="0"/></div>
            </div>
          </div>

          <!-- Layers panel removed; use floating Layers drawer (☷) -->

          <!-- Project actions -->
          <div class="panel actions-panel">
            <div class="panel-head">
              <h3>Project</h3>
            </div>
            <div class="actions-row">
              <button id="save-project" class="btn primary">Save Project</button>
              <button id="load-project" class="btn secondary">Load Project</button>
              <input type="file" id="load-project-input" accept="application/json" style="display:none"/>
            </div>
            <div class="actions-row">
              <button id="choose-audio" class="btn secondary">Choose audio files</button>
              <button id="snapshot" class="btn secondary">Snapshot</button>
              <button id="record" class="btn primary">Record</button>
            </div>
          </div>

          <!-- Live Console -->
          <div class="panel console-panel">
            <div class="panel-head">
              <h3>Live Console</h3>
              <div class="panel-actions">
                <button id="debug-toggle" class="btn secondary">Enable Debug</button>
                <button id="console-clear" class="btn secondary">Clear</button>
              </div>
            </div>
            <div id="live-console"></div>
          </div>

          <!-- Status -->
          <div class="panel status-panel">
            <div class="panel-head">
              <h3>Status</h3>
            </div>
            <pre id="status-info" class="status-pre">Initializing…</pre>
          </div>

        </div>
      </section>

      <!-- Playlists Sidebar -->
      <aside class="sidebar playlists">
        <ul id="playlists" class="list"></ul>
        <div id="playlist-details" class="playlist-details">
          <h3 id="playlist-title">Playlist</h3>
          <ul id="playlist-tracks" class="list tracks"></ul>
        </div>
      </aside>
    </div>
  </main>

  <!-- Speed Dial (Quick Add) -->
  <div id="speed-dial" class="md-speed-dial" aria-label="Quick actions">
    <button id="sd-toggle" class="md-fab" title="Quick actions">＋</button>
    <div class="dial-items">
      <button id="sd-add-playlist" class="icon-btn" title="Add Playlist">📝</button>
      <button id="sd-add-smart" class="icon-btn" title="Add Smart Playlist">⚙️</button>
      <button id="sd-add-current" class="icon-btn" title="Add Current Track">➕🎵</button>
      <button id="sd-del-playlist" class="icon-btn danger" title="Delete Selected Playlist">🗑</button>
    </div>
  </div>

  <!-- Floating Tools: search/upload/import/rescan -->
  <div id="float-tools" class="md-float-tools" aria-label="Library tools">
    <input type="text" id="float-search" placeholder="Search…" />
    <button id="float-rescan" class="btn secondary">Rescan</button>
    <label class="upload-btn" title="Upload audio files">
      Upload
      <input type="file" id="float-upload-input" accept="audio/*" multiple />
    </label>
    <input type="url" id="float-import-url" placeholder="Import URL" />
    <button id="float-import-btn" class="btn secondary">Import</button>
  </div>

  <!-- Upload progress overlay -->
  <div id="upload-overlay" class="md-overlay" aria-hidden="true">
    <div class="box">
      <div class="spinner"></div>
      <div class="text" id="upload-status">Uploading…</div>
    </div>
  </div>

  <!-- Playlist Create Drawer -->
  <div id="playlist-drawer" class="md-drawer" role="dialog" aria-modal="true" aria-labelledby="playlist-drawer-title">
    <div class="drawer-head">
      <h3 id="playlist-drawer-title">Create Playlist</h3>
      <button id="playlist-drawer-close" class="icon-btn" aria-label="Close">✕</button>
    </div>
    <div class="drawer-content">
      <div class="customize">
        <div class="viz-style">
          <label>Name</label>
          <input type="text" id="pl-name2" placeholder="Playlist name"/>
        </div>
        <div class="viz-style">
          <label>Filter</label>
          <input type="text" id="pl-filter" placeholder="Type to filter…"/>
        </div>
        <div class="presets">
          <button id="pl-create-btn" class="btn primary">Create with selected</button>
        </div>
        <div class="list" id="pl-lib-list" style="max-height:50vh; overflow:auto;"></div>
      </div>
    </div>
  </div>
  <div id="playlist-scrim" class="md-scrim" aria-hidden="true"></div>

  <!-- Playlist Select Drawer (for actions requiring a target) -->
  <div id="pl-select-drawer" class="md-drawer" role="dialog" aria-modal="true" aria-labelledby="pl-select-drawer-title">
    <div class="drawer-head">
      <h3 id="pl-select-drawer-title">Select Playlist</h3>
      <button id="pl-select-close" class="icon-btn" aria-label="Close">✕</button>
    </div>
    <div class="drawer-content">
      <ul id="pl-select-list" class="list"></ul>
    </div>
  </div>
  <div id="pl-select-scrim" class="md-scrim" aria-hidden="true"></div>

  <footer>
    <p>&copy; 2025 Avee-like Player (PHP)</p>
  </footer>

  

  <script src="assets/js/utils.js?v=20251020-17"></script>
  <script src="assets/js/equalizer.js?v=20251020-17"></script>
  <script src="assets/js/visualizer.js?v=20251020-19"></script>
  <script src="assets/js/playlists.js?v=20251020-17"></script>
  <script src="assets/js/settings.js?v=20251020-17"></script>
  <script src="assets/js/cloud.js?v=20251020-17"></script>
  <script src="assets/js/logger.js?v=20251020-17"></script>
  <script src="assets/js/toast.js?v=20251020-17"></script>
  <script src="assets/script.js?v=20251020-17"></script>
  <script>
    // Drawer open/close handling + top menu + speed dial
    (function() {
      function qs(id){ return document.getElementById(id); }
      const fab = qs('fab-customize');
      const drawer = qs('viz-drawer');
      const scrim = qs('viz-scrim');
      const closeBtn = qs('viz-drawer-close');
      const menuBtn = qs('top-menu');
      const menuPanel = qs('top-menu-panel');

      function openDrawer() {
        if (!drawer) return;
        drawer.classList.add('open');
        if (scrim) scrim.classList.add('show');
      }
      function closeDrawer() {
        if (!drawer) return;
        drawer.classList.remove('open');
        if (scrim) scrim.classList.remove('show');
      }

      if (fab) fab.addEventListener('click', openDrawer);
      if (menuBtn) menuBtn.addEventListener('click', async () => {
        if (!menuPanel) return;
        const willOpen = !menuPanel.classList.contains('open');
        menuPanel.classList.toggle('open');
        if (willOpen) {
          try { if (window.PlaylistUI && PlaylistUI.loadPlaylists) await PlaylistUI.loadPlaylists(); } catch (_) {}
        }
      });
      if (closeBtn) closeBtn.addEventListener('click', closeDrawer);
      if (scrim) scrim.addEventListener('click', closeDrawer);
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeDrawer();
          if (menuPanel) menuPanel.classList.remove('open');
        }
      });

      

      // Speed Dial: quick add playlist
      const sd = qs('speed-dial');
      const sdToggle = qs('sd-toggle');
      const sdAdd = qs('sd-add-playlist');
      const sdAddSmart = qs('sd-add-smart');
      if (sdToggle) sdToggle.addEventListener('click', () => {
        if (!sd) return;
        sd.classList.toggle('open');
      });
      if (sdAdd) sdAdd.addEventListener('click', () => {
        if (sd) sd.classList.remove('open');
        const d = document.getElementById('playlist-drawer');
        const s = document.getElementById('playlist-scrim');
        if (d) d.classList.add('open');
        if (s) s.classList.add('show');
        if (window.App && App.populatePlaylistCreateList) {
          App.populatePlaylistCreateList('');
        }
      });
      if (sdAddSmart) sdAddSmart.addEventListener('click', () => {
        const sd = qs('speed-dial');
        if (sd) sd.classList.remove('open');
        const d = qs('smart-drawer'), s = qs('smart-scrim');
        if (d) d.classList.add('open');
        if (s) s.classList.add('show');
      });

      // Layers drawer open/close
      const fabLayers = qs('fab-layers');
      const layersDrawer = qs('layers-drawer');
      const layersScrim = qs('layers-scrim');
      const layersClose = qs('layers-drawer-close');
      function openLayers() {
        if (layersDrawer) layersDrawer.classList.add('open');
        if (layersScrim) layersScrim.classList.add('show');
      }
      function closeLayers() {
        if (layersDrawer) layersDrawer.classList.remove('open');
        if (layersScrim) layersScrim.classList.remove('show');
      }
      if (fabLayers) fabLayers.addEventListener('click', openLayers);
      if (layersClose) layersClose.addEventListener('click', closeLayers);
      if (layersScrim) layersScrim.addEventListener('click', closeLayers);

      // Smart drawer close + create
      const smartDrawer = qs('smart-drawer');
      const smartScrim = qs('smart-scrim');
      const smartClose = qs('smart-drawer-close');
      if (smartClose) smartClose.addEventListener('click', () => { smartDrawer.classList.remove('open'); smartScrim.classList.remove('show'); });
      if (smartScrim) smartScrim.addEventListener('click', () => { smartDrawer.classList.remove('open'); smartScrim.classList.remove('show'); });
      const smartCreate = qs('smart-create-btn');
      if (smartCreate) smartCreate.addEventListener('click', async () => {
        const name = (qs('smart-name2').value || '').trim();
        const contains = (qs('smart-contains2').value || '').trim();
        const exts = (qs('smart-exts2').value || '').trim().toLowerCase();
        const folder = (qs('smart-folder2').value || '').trim();
        const minMb = Number(qs('smart-minmb2').value || '0');
        const maxMb = Number(qs('smart-maxmb2').value || '0');
        if (!name) { try { Toast && Toast.show('Enter smart playlist name', 'error'); } catch (_) {} return; }
        const rules = {
          contains,
          exts: exts ? exts.split(',').map(s => s.trim()).filter(Boolean) : [],
          folder,
          minBytes: minMb > 0 ? Math.round(minMb * 1024 * 1024) : 0,
          maxBytes: maxMb > 0 ? Math.round(maxMb * 1024 * 1024) : 0
        };
        try {
          if (window.PlaylistUI && PlaylistUI.createSmartByNameAndRules) {
            const res = await PlaylistUI.createSmartByNameAndRules(name, rules);
            if (res.ok) {
              try { Toast && Toast.show('Smart playlist created', 'success'); } catch (_) {}
              smartDrawer.classList.remove('open'); smartScrim.classList.remove('show');
            } else {
              try { Toast && Toast.show(res.error || 'Failed to create', 'error'); } catch (_) {}
            }
          } else {
            const res = await API.post('api/playlists.php', { action: 'create_smart', name, rules });
            if (res.ok) {
              try { Toast && Toast.show('Smart playlist created', 'success'); } catch (_) {}
              if (typeof PlaylistUI !== 'undefined') PlaylistUI.selectPlaylist(res.playlist.id);
              smartDrawer.classList.remove('open'); smartScrim.classList.remove('show');
            } else {
              try { Toast && Toast.show(res.error || 'Failed to create', 'error'); } catch (_) {}
            }
          }
        } catch (err) {
          console.error('Create smart error', err);
          try { Toast && Toast.show('Create failed: ' + err.message, 'error'); } catch (_) {}
        }
      });

      // Speed Dial extra actions: add current / delete selected / open layers
      const sdAddCurrent = qs('sd-add-current');
      if (sdAddCurrent) sdAddCurrent.addEventListener('click', async () => {
        const sd = qs('speed-dial'); if (sd) sd.classList.remove('open');
        try {
          const selId = (typeof PlaylistUI !== 'undefined' && PlaylistUI.getSelectedId) ? PlaylistUI.getSelectedId() : null;
          if (!selId) {
            // open select drawer and then add current to chosen playlist
            App.openPlaylistSelect(async (id, name) => {
              if (PlaylistUI.selectPlaylist) await PlaylistUI.selectPlaylist(id);
              if (PlaylistUI.addCurrent) await PlaylistUI.addCurrent();
              try { Toast && Toast.show(`Added current track to "${name}"`, 'success'); } catch (_) {}
            });
            return;
          }
          if (PlaylistUI.addCurrent) {
            await PlaylistUI.addCurrent();
            const plName = document.getElementById('playlist-title')?.textContent || 'Playlist';
            try { Toast && Toast.show(`Added current track to "${plName}"`, 'success'); } catch (_) {}
          }
        } catch (err) {
          console.error('Add current failed', err);
          try { Toast && Toast.show('Add failed: ' + err.message, 'error'); } catch (_) {}
        }
      });
      const sdDelPl = qs('sd-del-playlist');
      if (sdDelPl) sdDelPl.addEventListener('click', async () => {
        const sd = qs('speed-dial'); if (sd) sd.classList.remove('open');
        const ok = window.confirm('Delete selected playlist?');
        if (!ok) return;
        try {
          const selId = (typeof PlaylistUI !== 'undefined' && PlaylistUI.getSelectedId) ? PlaylistUI.getSelectedId() : null;
          if (!selId) {
            App.openPlaylistSelect(async (id, name) => {
              await API.post('api/playlists.php', { action: 'delete', id });
              if (PlaylistUI.loadPlaylists) await PlaylistUI.loadPlaylists();
              try { Toast && Toast.show(`Deleted "${name}"`, 'success'); } catch (_) {}
            });
            return;
          }
          const plName = document.getElementById('playlist-title')?.textContent || 'Playlist';
          if (PlaylistUI.deleteSelected) {
            await PlaylistUI.deleteSelected();
            try { Toast && Toast.show(`Deleted "${plName}"`, 'success'); } catch (_) {}
          }
        } catch (err) {
          console.error('Delete playlist failed', err);
          try { Toast && Toast.show('Delete failed: ' + err.message, 'error'); } catch (_) {}
        }
      });
      const sdLayers = qs('sd-open-layers');
      if (sdLayers) sdLayers.addEventListener('click', () => {
        const sd = qs('speed-dial'); if (sd) sd.classList.remove('open');
        openLayers();
      });

      // Add Layer via layers drawer with style choice and perf guard
      const layerAdd2 = qs('layer-add2');
      if (layerAdd2) layerAdd2.addEventListener('click', () => {
        try {
          const style = (qs('layer-style')?.value) || 'circle';
          const c1 = (qs('layer-color-1')?.value) || '#19d3ae';
          const c2 = (qs('layer-color-2')?.value) || '#1e90ff';
          const seg = Number((qs('layer-segments')?.value) || 2);
          const blend = (qs('layer-blend')?.value) || 'lighter';
          const alpha = Number((qs('layer-alpha')?.value) || 1);
          const idx = App.state.viz.addLayer(style, {
            color1: c1, color2: c2,
            rotation: Number(document.getElementById('viz-rot').value || 0.6),
            thickness: Number(document.getElementById('viz-thickness').value || 1),
            ringFloor: Number(document.getElementById('viz-ring-floor').value || 0.16),
            radialFloor: Number(document.getElementById('viz-radial-floor').value || 0.16),
            spikeScale: Number(document.getElementById('viz-spike-scale').value || 1),
            waveScale: Number(document.getElementById('viz-wave-scale').value || 1),
            segments: Math.max(1, Math.min(8, seg)),
            blend,
            alpha
          });
          App.state.viz.selectLayer(idx);
          App.renderLayersUI();
          // Performance guard: if more than 1 layer, enforce performance mode and soften trail
          const count = App.state.viz.getLayers().length;
          if (count > 1 && App.state.viz.setPerformanceMode) {
            App.state.viz.setPerformanceMode(true);
            const perfToggle = document.getElementById('viz-perf'); if (perfToggle) perfToggle.checked = true;
            if (App.state.viz.setTrailAlpha) App.state.viz.setTrailAlpha(0.05);
            if (App.state.viz.setGlowStrength) App.state.viz.setGlowStrength(Math.min(12, Number(document.getElementById('viz-glow-strength').value || 12)));
          }
          try { Toast && Toast.show('Layer added', 'success', 1500); } catch (_) {}
          closeLayers();
        } catch (err) {
          console.error('Add layer failed', err);
          try { Toast && Toast.show('Add layer failed: ' + err.message, 'error'); } catch (_) {}
        }
      });
    })();
  </script>

  <script src="assets/js/app.js?v=20251020-19"></script>
</body>
</html>